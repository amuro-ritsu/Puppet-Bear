# 🐻 Puppet Bear v1.14.2 (Puppet Anchor Fix)

**パペットレイヤーのアンカーポイント処理を修正**

## 🐛 v1.14.2 バグ修正

### 🎯 修正内容

#### 1. **パペットレイヤーのアンカーオフセット修正** ✨FIX✨
- パペットレイヤーの描画処理で、アンカーオフセット計算を通常レイヤーと統一
- 読み込み直後にアンカー設定しても画像が動かなくなりました
- fallbackDrawImage（WebGL未使用時）の描画を修正
- WebGL描画時のアンカーオフセット処理も修正
- 軸アンカー（赤い十字マーク）の描画位置も修正

**修正前の問題**: パペットレイヤーでは独自のアンカーオフセット計算をしていたため、読み込み直後にアンカーを設定すると画像が移動してしまっていました。

**修正後**: 通常の画像レイヤーと同じアンカーオフセット処理に統一し、アンカー設定時に画像が動かなくなりました。

---

# 🐻 Puppet Bear v1.14.1 (UI Improvements)

**アンカーポイント設定に関する注意書きを追加**

## ⚠️ v1.14.1 UI改善

### 🎯 改善内容

#### 1. **アンカーポイント警告表示** ✨NEW✨
- ヘッダーのアンカースライダーに警告メッセージを表示
- 「⚠️ トランスフォーム前に設定」
- トランスフォームスライダーと数値入力の同期を改善

#### 2. **重要な注意事項をREADMEに追加**
- アンカーポイント設定の正しい作業順序を明記
- 推奨される操作手順を説明

---

# 🐻 Puppet Bear v1.14.0 (Undo/Redo)

**アンドゥ/リドゥ機能を実装 - 操作の取り消しと再実行が可能に**

## ↩️ v1.14.0 アンドゥ/リドゥ機能

### 🎯 新機能

#### 1. **アンドゥ/リドゥ** ✨NEW✨
操作履歴の管理機能：
- **↩️ 元に戻す（Undo）** - Ctrl+Z で直前の操作を取り消し
- **↪️ やり直し（Redo）** - Ctrl+Y で取り消した操作を再実行
- **ヘッダーボタン** - ロゴ横のボタンからも操作可能
- **最大50件の履歴** - 50操作分まで遡れます

#### 2. **対応操作**
以下の操作が履歴に保存されます：
- レイヤーの追加・削除（画像、フォルダ、口パク、まばたき、揺れモーション、パペット、音声）
- レイヤーの移動・回転・スケール変更
- キーフレームの追加・編集
- プロパティの変更

### 📝 使い方
- **キーボード**: Ctrl+Z（元に戻す）、Ctrl+Y（やり直し）
- **ボタン**: ヘッダー左側の ↩️↪️ ボタンをクリック

### 💡 技術的な改善
- **app-history.js**: 履歴管理モジュール（NEW）
  - レイヤー状態のシリアライズ/デシリアライズ
  - 画像データのキャッシュ対応
  - 非同期復元処理

---

# 🐻 Puppet Bear v1.13.0 (Touch & PWA)

**タブレット対応とPWA機能を実装 - ホーム画面への追加対応**

## 📱 v1.13.0 タッチ操作・PWA対応

### 🎯 新機能

#### 1. **タッチ操作対応** ✨NEW✨
タブレットでの使用を想定した操作対応：
- **キャンバスでのタッチ操作** - 1本指でレイヤーの移動・回転
- **ピンチズーム** - 2本指でレイヤーのスケール変更
- **タイムラインのタッチ操作** - スクラブ操作で再生位置変更
- **各種ピン追加** - タップでピン追加対応

#### 2. **PWA対応（ホーム画面への追加）** ✨NEW✨
スマートフォン・タブレットのホーム画面にアプリとして追加可能：
- **📲 アプリ追加ボタン** - 対応ブラウザで自動表示
- **アプリアイコン** - チョコレート＆ゴールドスターデザイン
- **スタンドアロンモード** - ブラウザUIなしで起動
- **横向き最適化** - ランドスケープモードに対応

#### 3. **オフライン対応** ✨NEW✨
Service Workerによるキャッシュ機能：
- **アセットキャッシュ** - 一度読み込めばオフラインでも使用可能
- **オフラインインジケーター** - ネットワーク切断時に表示

#### 4. **タブレット向けUI最適化** ✨NEW✨
- **タップ領域拡大** - ボタン・キーフレームのタップしやすさ向上
- **レスポンシブデザイン** - 画面サイズに応じたレイアウト調整
- **セーフエリア対応** - ノッチ付きデバイスへの対応
- **ダブルタップズーム防止** - 意図しないズームを防止

### 📝 使い方

#### ホーム画面への追加
**Android（Chrome）:**
1. Chromeでアプリを開く
2. 「📲 アプリ追加」ボタンをタップ
3. 「ホーム画面に追加」を選択

**iOS（Safari）:**
1. Safariでアプリを開く
2. 共有ボタン 📤 をタップ
3. 「ホーム画面に追加」を選択
4. 「追加」をタップ

#### タッチ操作
- **レイヤー移動**: 「👇 移動」ツール選択後、1本指でドラッグ
- **レイヤー回転**: 「🔁 回転」ツール選択後、1本指でドラッグ
- **スケール変更**: 2本指でピンチイン/アウト
- **再生位置変更**: タイムライン上を1本指でドラッグ

### 💡 技術的な改善
- **app-touch.js**: タッチイベント処理・PWA機能
  - タッチイベントハンドリング
  - ピンチズーム検出
  - Service Worker登録
  - PWAインストールプロンプト
- **service-worker.js**: オフラインキャッシュ
- **manifest.json**: PWAマニフェスト
- **styles.css**: タブレット向けレスポンシブスタイル

### 📁 ファイル構成
```
PuppetBear-v1_13_0/
├── index.html           # メインHTML（PWAメタタグ追加）
├── styles.css           # スタイルシート（タブレット対応追加）
├── manifest.json        # PWAマニフェスト（NEW）
├── service-worker.js    # Service Worker（NEW）
├── icon-192.png         # PWAアイコン192x192（NEW）
├── icon-512.png         # PWAアイコン512x512（NEW）
├── app.js               # メインJS
├── app-core.js          # コア機能
├── app-touch.js         # タッチ操作・PWA（NEW）
├── app-windsway.js      # 風揺れ
├── app-bounce.js        # 揺れモーション
├── app-puppet.js        # パペット
├── app-audio.js         # 音声レイヤー
├── app-timeline.js      # タイムライン
├── app-animation.js     # アニメーション
├── app-layers.js        # レイヤー管理
├── app-tools.js         # ツール機能
├── app-clipping.js      # クリッピング
├── app-properties.js    # プロパティパネル
├── app-export.js        # 書き出し
├── seekbar-bear.png     # 再生ヘッドアイコン
├── pins/                # ピンアイコン
└── README.md            # このファイル
```

---

# 🐻 Puppet Bear v1.12.0 (Export & Loop)

**書き出し機能とループ再生を実装 - アニメーション出力対応**

## 📤 v1.12.0 書き出し機能実装

### 🎯 新機能

#### 1. **書き出し機能** ✨NEW✨
ブラウザ上でローカル処理による動画・画像出力：
- **WebM (動画)** - 透過対応・軽量な動画形式（MediaRecorder使用）
- **連番PNG (ZIP)** - 高品質な透過画像シーケンス

#### 2. **書き出し範囲マーカー** ✨NEW✨
タイムライン上で書き出し範囲を視覚的に設定：
- **開始マーカー（緑）** - 書き出し開始位置
- **終了マーカー（赤）** - 書き出し終了位置
- **ドラッグで移動** - マーカーをドラッグして範囲調整
- **自動検出** - マーカー未設定時は最後のオブジェクトまで自動設定

#### 3. **ループ再生機能** ✨NEW✨
- チェックボックスで簡単切り替え
- 書き出し範囲をループ（マーカー設定時）
- プレビュー確認に便利

#### 4. **書き出しオプション**
- **音声の有無** - 音声レイヤーを含めるか選択
- **背景透過** - WebM/PNGで透過出力
- **解像度選択** - Full HD / HD / Half HD / SD / キャンバスサイズ
- **ビットレート調整** - 1〜20 Mbps

#### 5. **タイムラインズーム** ✨NEW✨
- スライダーでタイムラインの拡大・縮小
- 25%〜300%の範囲で調整可能
- リセットボタンで100%に戻す

### 📝 使い方

#### 書き出し手順
1. タイムライン上でアニメーションを作成
2. 必要に応じて書き出し範囲マーカーを設定
   - 現在位置ボタンで簡単設定
   - マーカーをドラッグして調整
3. 「📤 書き出し」ボタンをクリック
4. 形式・オプションを選択
5. 「書き出し開始」で出力

#### ループ再生
1. 「🔁 ループ」チェックボックスをON
2. 再生ボタンで再生開始
3. 終了位置で自動的に開始位置に戻る

### 💡 技術的な改善
- **app-export.js**: 書き出し機能のコア実装
  - MediaRecorder APIによる動画キャプチャ
  - JSZipによる連番PNG圧縮
  - プログレスバー表示
  - マーカードラッグ対応
- **app-animation.js**: ループ再生チェック追加
- **app-timeline.js**: マーカー描画対応
- **styles.css**: 書き出しUI用スタイル追加

---

# 🐻 Puppet Bear v1.9.0 (Puppet Layer)

**パペットレイヤー機能を実装 - 1本の骨構造による変形システム**

## 🎭 v1.9.0 パペットレイヤー実装

### 🎯 新機能

#### 1. **パペットレイヤー - 1本の骨構造** ✨NEW✨
パペットレイヤーは3つの要素で構成されます：
- **軸アンカー**: 変形の基準点（既存のアンカー）
- **ハンドルアンカー**: 変形用のハンドル、これを動かすと軸を基準に湾曲
- **中間ピン**: カーブを追加するためのピン（うねうねさせたいときに追加）

#### 2. **パペットアンカー追従機能** ✨NEW✨
- 各種レイヤー（画像、口パク、まばたき、揺れモーション）に「パペットアンカーに追従」を追加
- 他のレイヤーがパペットレイヤーのハンドルアンカーに追従可能
- **用途例**: 胴体パペットレイヤーの変形に頭レイヤーが追従

#### 3. **使い方**
1. 「🎭 パペット追加」ボタンで画像を選択
2. プロパティパネルの「🎯 ハンドル設定」をONにしてクリック → ハンドルアンカー配置
3. 「📍 中間ピン追加」をONにしてクリック → カーブ用ピン配置（任意）
4. 再生ヘッドを移動してハンドル・ピンをドラッグ → 自動でキーフレーム登録
5. 他のレイヤーのプロパティで「パペットアンカーに追従」を設定 → ハンドルに追従

#### 4. **パペット設定**
- **変形強度**: 湾曲の強さを調整（0.0～3.0）
- **中間ピン**: カーブを追加（複数配置可能）
- **タイムライン**: ハンドルと各ピンごとにキーフレーム表示

#### 5. **WebGL変形**
- 20x20の細かいメッシュグリッド
- なめらかな曲線変形
- リアルタイムプレビュー

#### 6. **用途**
- 胴体の変形に頭・手足を追従
- 髪の毛の揺れ（ハンドルで先端、中間ピンでカーブ）
- 表情の微調整
- 有機的なアニメーション

---

# 🐻 Puppet Bear v1.8.7 (Smooth Transform)

**風揺れの変形曲線を滑らか化 - より自然なアニメーションを実現**

## 🔧 v1.8.7 滑らか化バージョン

### 🎯 新機能と改善

#### 1. **風揺れの変形曲線を滑らか化**
- メッシュ分割数を大幅に増加（15→30）
- smoothstep/smootherstep補間を実装
- より細かく自然な変形を実現

#### 2. **揺れモーションの変形曲線も滑らか化** ✨NEW✨
- 風揺れと同じsmoothstep補間を実装
- メッシュ分割数を増加（20→30）
- ピンの影響範囲をsmootherstepで滑らかに
- アンカーからの減衰を自然に
- ガタガタした変形が解消され、より有機的な動きに

#### 3. **アンカー設定とピンモードの競合を修正** 🔧FIX🔧
- アンカー設定モードとピンモードが互いに無効化するように改善
- ピンモード有効時もアンカーを再設定できるように修正
- すべてのモード（アンカー設定、揺れピン、風揺れピン）が正しく切り替わるように
- **キーフレーム入力後もアンカーを再設定できるように修正（重要！）**
- **いつでも何度でもアンカー位置を変更できます**

#### 4. **ピンの影響範囲を改善**
- 単純な2乗補間からsmootherstep補間に変更
- ピン周辺の変形がより自然に
- 急激な変化がなくなり滑らかな減衰を実現

#### 5. **アンカーポイントからの減衰を最適化**
- 線形補間からsmoothstep補間に変更
- アンカーポイントから遠ざかるほど自然に揺れが増加
- より有機的な動きを実現
- 各プリセットの分割数を増加
  - 優しい風: 10→25
  - 普通の風: 15→30
  - 強い風: 20→35
  - 旗: 25→40
  - カーテン: 30→45
  - 水中: 20→35

### 💡 技術的な改善
- **app-windsway.js**: 
  - smoothstep補間関数を追加
  - smootherstep補間関数を追加
  - cosine補間関数を追加
  - ピン影響範囲計算をsmootherstepに変更
  - アンカーポイント減衰計算をsmoothstepに変更
  - デフォルト分割数を30に増加
  - すべてのプリセットの分割数を最適化
  - togglePinMode関数で他のモードを無効化
- **app-bounce.js**: ✨NEW✨
  - smoothstep補間関数を追加
  - smootherstep補間関数を追加
  - ピン影響範囲計算をsmootherstepに変更
  - アンカー距離計算をsmoothstepに変更
  - 弾み方向の距離計算もsmoothstepに変更
  - デフォルト分割数を30に増加
  - 揺れタイプの変形がより滑らかで自然に
  - toggleBouncePinMode関数で他のモードを無効化
  - 🔧 キーフレームに保存されたアンカーではなく、常に現在のレイヤーのアンカーを使用（重要！）
- **app-properties.js**: 🔧FIX🔧
  - setAnchorPointClick関数で他のモードを無効化
  - アンカー設定時にピンモードを自動解除
  - モード切り替えがスムーズに動作するように改善

### ✅ 既存機能はそのまま
- アンカーポイントクリック設定機能
- ピン機能
- すべてのプリセット
- キーフレーム対応

## 🔧 v1.7.2 バグ修正

### 🎯 修正内容
1. **アンカーポイント追加が動作しない問題を修正**
   - クリックイベントハンドラの優先順位を修正
   - `anchorPointPickMode` のチェックを最優先に設定
   - アンカーポイント設定モードが正しく機能するようになりました

2. **弾むアニメーションの反転問題を修正**
   - メッシュ生成のY座標計算を修正
   - 座標系を統一（X・Y両方とも中心が0）
   - ゴムのように自然に伸縮する動きを実現

### 💡 技術的な変更
- **app.js**: キャンバスクリックイベントの優先順位を整理
- **app-bounce.js**: メッシュ生成ロジックの座標系を統一

### 📚 レイヤーパネル常時表示
- **起動時から完全表示** - タイトル、説明、ボタンがすべて表示
- **!important指定による安定化** - CSSの表示優先度を最高レベルに設定
- **JavaScript初期化強化** - DOM読み込み後に明示的に表示を確保

### ⚓ アンカーポイントベースの変形システム
- **ピン機能を排除** - よりシンプルで直感的な操作
- **アンカーポイントが変形の軸に** - アンカーに向かって画像が伸縮
- **わかりやすいUI** - 「アンカーポイント（変形の軸）」と明示

### 💫 使い方
1. 揺れモーションレイヤーを作成
2. **アンカーポイントを設定** - これが変形の軸になります
3. 弾み方向を選択
   - **下に向かって** → アンカーより上が伸縮（胸の揺れなど）
   - **上に向かって** → アンカーより下が伸縮（髪の揺れなど）
4. キーフレームを挿入してアニメーション開始

### 🎯 具体例
- **胸の揺れ** → アンカーを上（胸の付け根）に配置、下に向かってモード
- **髪の揺れ** → アンカーを下（髪の根元）に配置、上に向かってモード
- **しっぽの揺れ** → アンカーを付け根に配置

## ✨ 主な機能

### 🎈 揺れモーション
- **弾み（Y軸伸縮のみ）** - シンプルな上下の弾み
- **揺れ（伸縮+左右揺れ）** - 風揺れベースの複雑な揺れ
- **減衰アニメーション** - 自然な揺れの余韻
- **キーフレーム対応** - 複数回のアニメーション挿入可能

### 🎨 その他の機能
- **タイムラインエディタ** - 30fpsのアニメーション編集
- **キーフレームアニメーション** - 位置、回転、スケール、不透明度
- **風揺れエフェクト** - ピンベースのメッシュ変形
- **口パクレイヤー** - 連番画像による口パクアニメーション
- **まばたきレイヤー** - 自動まばたきアニメーション
- **色抜きクリッピング** - 特定色を抜いてマスク生成
- **親子関係** - レイヤーの階層管理
- **ブレンドモード** - 15種類のブレンドモード対応

## 🎮 基本操作

- **レイヤー追加** - 画像をドラッグ&ドロップ
- **選択** - レイヤーをクリック
- **移動** - ポジションツールでドラッグ
- **回転** - 回転ハンドルツールでドラッグ
- **アンカー設定** - クリック設定ボタンを押してキャンバスをクリック

## 📁 ファイル構成

```
PuppetBear_v1_7_2/
├── index.html              メインHTML
├── styles.css              スタイルシート
├── app.js                  アプリケーションメイン（v1.7.2 更新！）
├── app-core.js             コア機能
├── app-layers.js           レイヤー管理
├── app-properties.js       プロパティパネル
├── app-animation.js        キーフレームアニメーション
├── app-timeline.js         タイムライン
├── app-tools.js            ツール操作
├── app-windsway.js         風揺れエフェクト
├── app-bounce.js           揺れモーション（v1.7.2 更新！）
├── app-clipping.js         色抜きクリッピング
├── pins/                   ピン画像（風揺れ用）
└── README.md               このファイル
```

## 🔧 技術仕様

- **レンダリング** - Canvas 2D API + WebGL
- **アニメーション** - 30fps固定
- **メッシュ変形** - 20×10グリッド（揺れモーション）
- **キーフレーム補間** - 線形補間
- **プロジェクト保存** - JSON形式

## 📝 変更履歴

### v1.8.7 滑らか化版 (2025-11-24)
- ✨ 風揺れの変形曲線を大幅に滑らか化
- ✨ 揺れモーションの変形曲線も滑らか化（NEW！）
- 🎯 メッシュ分割数を増加（風揺れ15→30、揺れ20→30）
- 🔧 smoothstep/smootherstep補間を実装（両方に適用）
- 💫 ピンの影響範囲をより自然に（両方に適用）
- 🌊 アンカーポイント減衰をsmoothstepに変更（両方に適用）
- 🎨 すべてのプリセットの分割数を最適化
- 🔥 ガタガタした変形が解消され、より有機的な動きを実現
- 🔧 アンカー設定モードとピンモードの競合を修正（重要！）
- ✅ ピン設定後もアンカーを再設定できるように改善
- 🎯 すべてのモードが正しく切り替わるように修正
- 🔥 **キーフレーム入力後もアンカーを再設定できるように修正（重要！）**
- ✨ キーフレームに保存されたアンカーではなく、常に現在のレイヤーのアンカーを使用

### v1.7.2 バグ修正版 (2025-11-23)
- 🐛 アンカーポイントがクリックしても追加できない問題を修正
- 🐛 弾むアニメーションが反転する問題を修正
- 🎯 座標系を統一してゴムのような自然な伸縮を実現
- 🔧 イベントハンドラの優先順位を最適化

### v1.7.0 レイヤーパネル常時表示版 (2025-11-23)
- 📚 レイヤーパネルを起動時から完全表示
- 🎯 タイトル、説明、全ボタンが常に表示される
- 💪 !important指定による表示の安定化
- 🔧 JavaScript初期化コードで表示を確保

### v1.7.0 (2025-11-23)
- ⚓ アンカーポイントベースの変形システムに移行
- ❌ ピン機能を排除（よりシンプルに）
- 📝 UIの説明を改善
- 🐛 変形の軸の問題を解決

### v1.6.6
- 🎈 揺れモーションレイヤーの安定化
- 🐛 各種バグ修正

## ⚠️ 重要な注意事項

### 📍 アンカーポイントの設定について

**アンカーポイントは、画像の配置・回転・拡縮を行う前に設定してください。**

- ✅ **推奨**: レイヤー追加直後にアンカーポイントを設定
- ✅ **推奨**: トランスフォーム操作前にアンカーポイントを設定
- ❌ **非推奨**: 画像を移動・回転・拡縮した後にアンカーポイントを変更

**理由**: アンカーポイントを変更すると画像の描画基準点が変わるため、すでに配置・変形した画像の位置がずれてしまいます。

**正しい作業順序**:
1. 画像レイヤーを追加
2. アンカーポイントを設定（ヘッダーのスライダーまたはクリック設定）
3. トランスフォームツールで画像を配置・回転・拡縮
4. パペットアンカーポイントを追加（パペットレイヤーの場合）

## 🎯 今後の予定

- [ ] 揺れモーションの挙動最適化
- [ ] パフォーマンス向上
- [ ] プリセット機能
- [ ] エクスポート機能の強化

## 📜 ライセンス

MIT License

---

**Puppet Bear v1.8.7 - Smooth Transform**  
アンカーポイントに向かって、画像が躍動する✨  
より滑らかで自然なアニメーションを実現🎨
